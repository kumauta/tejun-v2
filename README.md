# 手順管理ツール (tejun-v2)

手動オペレーションに必要なコマンド実行手順を、ブラウザだけで安全に整理・確認するためのツールです。  
外部通信は行わず、DSL（ドメイン固有言語）で記述された手順をパースして、コピー操作・エビデンス記録・実行ログの可視化を行います。

## 特長
- ブラウザのみで動作し、ネットワーク通信は発生しません（静的ファイルのためオフライン利用可能）。
- DSLで手順を記述し、構造化して表示。
- 各コマンドの横にコピー用ボタンを配置。コピーした時刻を履歴として保持し、画面上で確認できます（直近5件）。
- コピー直後にエビデンス入力フォームを開き、実行結果や確認事項を紐付けて保存できます。
- 実行済みの手順とエビデンスをMarkdown形式でポップアップ表示し、そのままコピーできます。
- コマンド内に `{{VAR_NAME}}` 形式の変数を定義し、入力フォームから一括で値を適用できます。

## 使い方
1. `index.html` をブラウザで開くだけで利用できます。ローカルファイルとしてダブルクリックで開いてください。
2. 画面左側のテキストエリアにDSLを入力し、「手順を更新」を押すと右側に手順が展開されます。
3. 各コマンドの `コピー` ボタンでコマンドをクリップボードに取り込みます。コピー時間がボタン下に記録され、同時にエビデンス入力フォームが開きます。
4. フォームに実行結果や確認事項を入力して「記録する」を押すと、コマンドごとに履歴が積み上がります。
5. 画面最下部の「実行結果をエクスポート」ボタンから、コピー履歴とエビデンスを含むMarkdownをポップアップ表示できます（実行済みデータがない場合は無効化されます）。
6. ポップアップ内の「Markdownをコピー」ボタンで成果物をクリップボードへ保存し、そのまま記録に貼り付けられます。
7. 「サンプルを読み込む」ボタンでDSLの例をロードできます。

## DSL仕様

手順はキーと値を `:` で結んで記述します。空行が出現すると、それまでに定義された `step` が確定します。

```
title: サンプル手順タイトル
description: 手順全体の説明（任意）

step: ステップ名
note: 補足説明（任意）
command: 実行するコマンド1
command: 実行するコマンド2

step: 次のステップ
command: ...
```

- `title` と `description` は手順全体の情報です（任意ですが、あると画面に表示されます）。
- `step` は必須で、ステップタイトルを設定します。
- `note` は直前の `step` / `command` に対する補足説明です（任意、複数可）。
- `warn`（または `warning`）は `note` と同じ書き方で、画面上では赤字で強調表示されます。
- `command` は1つ以上必要です。同じステップ内で複数指定すると、実行順のリストとして表示されます（画面表示時は先頭に `$` が付与されますが、コピー内容には含まれません）。
- `root_command` は root 権限で実行するコマンドです。表示時は先頭に `#` が付与され、コピー時には取り除かれます。
- `env` を使うと、変数入力フォームへ初期値を埋め込めます（例: `env: TARGET_HOST=stg-app01`）。
- `#` または `//` で始まる行はコメントとして無視されます。

### 複数行コマンドの記法

複数行のコマンドを記述する場合は `command: |` と書き、次行以降をインデントして記載します。

```
step: ログ採取
command: |
  sudo journalctl -u example.service --since "-5 minutes"
  sudo tail -n 200 /var/log/example.log
```

ブロックは空行か次のキーワード（`step`, `command` など）の出現で終端します。インデントはスペース／タブどちらでも構いません。

### `note` の付け方

- `step` 内で最初の `command` より前に記述した `note` はステップ全体の注意事項になります。
- `command` の後ろに続けて複数行の `note` を記述すると、そのコマンド専用の補足が順番に表示されます。
- 例:

```
step: サービス停止
note: 作業時間は通知済みか確認
root_command: systemctl stop example.service
note: 停止には最大30秒かかる
note: 停止後にアラート抑止を継続
warning: 同時間帯に他ジョブが無いか再確認
warn: 作業完了後に監視へ連絡する
root_command: systemctl restart example.service
```

### 変数の使い方

- コマンド中に `{{VARIABLE_NAME}}` の形式で変数を記述すると、入力欄直下に変数設定フォームが表示されます。
- 変数名には英数字とアンダースコア（`_`）が利用できます。
- すべての変数へ値を入力したうえで「手順に反映」を押すと、手順中のコマンドへ値が差し込まれます。
- 変数が未設定のコマンドはコピー操作できません。値を反映後にコピー・エクスポートを行ってください。

例:

```
command: ssh deploy@{{TARGET_HOST}}
command: sudo systemctl restart {{SERVICE_NAME}}
```

### 環境変数の事前設定

- DSL内で `env: NAME=VALUE` を指定すると、変数入力フォームへ初期値として読み込まれます。
- 例:

  ```
  env: TARGET_HOST=stg-app01.internal
  env: SERVICE_NAME=example-api
  ```

- フォームに手動入力した値が常に優先されるため、DSL側の初期値を上書きして運用できます。


構文エラーがある場合、入力欄下部にエラーメッセージが表示されます。

## 開発メモ
- 追加のビルドステップや依存パッケージはありません。HTML/CSS/JSで完結しています。
- コピー履歴やエビデンスはブラウザ上のメモリで管理しており、ページ更新でリセットされます。
- エクスポートはMarkdownとして画面表示し、ブラウザ内でコピーするだけなのでネットワーク送信は発生しません。

## ローカル実行方法
1. `docker run --name nginx --rm -p 8080:80 -v $PWD:/usr/share/nginx/html:ro nginx` を実行します。
2. ブラウザで `http://localhost:8080/` にアクセスします。

## オンライン版
1. ブラウザで https://kumauta.github.io/tejun-v2/ にアクセスします。
